/*!
 * CronManager - Create and run cronjobs within the manager
 * Version: 1.2.5
 * Build date: 2021-11-11
 */

var cronmanager=function(e){return e=e||{},Ext.applyIf(e,{}),cronmanager.superclass.constructor.call(this,e),this};Ext.extend(cronmanager,Ext.Component,{page:{},window:{},grid:{},tree:{},panel:{},combo:{},config:{}}),Ext.reg("cronmanager",cronmanager),CronManager=new cronmanager,MODx.config.help_url="https://jako.github.io/CronManager/usage/",CronManager.combo.Snippets=function(e){e=e||{},Ext.applyIf(e,{name:"snippet",hiddenName:"snippet",displayField:"name",valueField:"id",fields:["id","name"],pageSize:20,minChars:1,editable:!0,triggerAction:"all",typeAhead:!0,forceSelection:!0,selectOnFocus:!1,url:CronManager.config.connectorUrl,baseParams:{action:"mgr/snippets/getlist",combo:!0},emptyText:_("cronmanager.selectasnippet")}),CronManager.combo.Snippets.superclass.constructor.call(this,e)},Ext.extend(CronManager.combo.Snippets,MODx.combo.ComboBox),Ext.reg("cronmanager-combo-snippets",CronManager.combo.Snippets),CronManager.combo.Error=function(e){e=e||{},Ext.applyIf(e,{store:new Ext.data.SimpleStore({fields:["d","v"],data:[[_("cronmanager.logs_filter_all"),"all"],[_("cronmanager.logs_filter_no_error"),"0"],[_("cronmanager.logs_filter_error"),"1"]]}),displayField:"d",valueField:"v",value:"all",mode:"local",name:"error",hiddenName:"error",triggerAction:"all",editable:!1,selectOnFocus:!1,listWidth:0}),CronManager.combo.Error.superclass.constructor.call(this,e)},Ext.extend(CronManager.combo.Error,Ext.form.ComboBox),Ext.reg("cronmanager-combo-error",CronManager.combo.Error),CronManager.panel.Home=function(e){e=e||{},Ext.applyIf(e,{cls:"container home-panel"+(CronManager.config.debug?" debug":""),defaults:{collapsible:!1,autoHeight:!0},items:[{html:"<h2>"+_("cronmanager")+"</h2>"+(CronManager.config.debug?'<div class="ribbon top-right"><span>'+_("cronmanager.debug_mode")+"</span></div>":""),border:!1,cls:"modx-page-header"},{defaults:{autoHeight:!0},border:!0,cls:"cronmanager-panel",items:[{html:"<p>"+_("cronmanager.cronjobs_desc")+"</p>",border:!1,cls:"panel-desc"},{layout:"form",cls:"x-form-label-left main-wrapper",defaults:{autoHeight:!0},border:!0,items:[{xtype:"cronmanager-grid-cronjobs",preventRender:!0}]}]},{cls:"treehillstudio_about",html:'<img width="146" height="40" src="'+CronManager.config.assetsUrl+'img/mgr/treehill-studio-small.png" srcset="'+CronManager.config.assetsUrl+'img/mgr/treehill-studio-small@2x.png 2x" alt="Treehill Studio">',listeners:{afterrender:function(e){e.getEl().select("img").on("click",function(){var e='<span style="display: inline-block; text-align: center">&copy; 2011-2019 by <a href="https://oostdesign.com/" target="_blank">OostDesign</a><br><img src="'+CronManager.config.assetsUrl+'img/mgr/treehill-studio.png" srcset="'+CronManager.config.assetsUrl+'img/mgr/treehill-studio@2x.png 2x" alt="Treehill Studio" style="margin-top: 10px"><br>&copy; 2019-2021 by <a href="https://treehillstudio.com" target="_blank">Treehill Studio</a></span>';Ext.Msg.show({title:_("cronmanager")+" "+CronManager.config.version,msg:e,buttons:Ext.Msg.OK,cls:"treehillstudio_window",width:358})})}}}]}),CronManager.panel.Home.superclass.constructor.call(this,e)},Ext.extend(CronManager.panel.Home,MODx.Panel),Ext.reg("cronmanager-panel-home",CronManager.panel.Home),CronManager.panel.Logs=function(e){e=e||{},Ext.applyIf(e,{cls:"container home-panel"+(CronManager.config.debug?" debug":""),defaults:{collapsible:!1,autoHeight:!0},items:[{html:"<h2>"+_("cronmanager.log")+"</h2>"+(CronManager.config.debug?'<div class="ribbon top-right"><span>'+_("cronmanager.debug_mode")+"</span></div>":""),border:!1,cls:"modx-page-header",listeners:{afterrender:{fn:function(n){e.cronjob&&MODx.Ajax.request({url:CronManager.config.connectorUrl,params:{action:"mgr/cronjobs/get",id:e.cronjob},listeners:{success:{fn:function(e){var r="<h2>"+_("cronmanager.log")+": "+e.object.snippet_name+" ("+e.object.id+")</h2>"+(CronManager.config.debug?'<div class="ribbon top-right"><span>'+_("cronmanager.debug_mode")+"</span></div>":"");n.body.update(r),this.fireEvent("ready",e.object)},scope:this}}})},scope:this}}},{defaults:{autoHeight:!0},border:!0,cls:"cronmanager-panel",items:[{html:"<p>"+_("cronmanager.logs_desc")+"</p>",border:!1,cls:"panel-desc"},{layout:"form",cls:"x-form-label-left main-wrapper",defaults:{autoHeight:!0},border:!0,items:[{xtype:"cronmanager-grid-cronjoblog",preventRender:!0,cronjob:e.cronjob}]}]},{cls:"treehillstudio_about",html:'<img width="146" height="40" src="'+CronManager.config.assetsUrl+'img/mgr/treehill-studio-small.png" srcset="'+CronManager.config.assetsUrl+'img/mgr/treehill-studio-small@2x.png 2x" alt="Treehill Studio">',listeners:{afterrender:function(e){e.getEl().select("img").on("click",function(){var e='<span style="display: inline-block; text-align: center">&copy; 2011-2019 by <a href="https://oostdesign.com/" target="_blank">OostDesign</a><br><img src="'+CronManager.config.assetsUrl+'img/mgr/treehill-studio.png" srcset="'+CronManager.config.assetsUrl+'img/mgr/treehill-studio@2x.png 2x" alt="Treehill Studio" style="margin-top: 10px"><br>&copy; 2019-2021 by <a href="https://treehillstudio.com" target="_blank">Treehill Studio</a></span>';Ext.Msg.show({title:_("cronmanager")+" "+CronManager.config.version,msg:e,buttons:Ext.Msg.OK,cls:"treehillstudio_window",width:358})})}}}]}),CronManager.panel.Logs.superclass.constructor.call(this,e)},Ext.extend(CronManager.panel.Logs,MODx.FormPanel),Ext.reg("cronmanager-panel-logs",CronManager.panel.Logs),CronManager.grid.CronJobs=function(e){e=e||{},this.buttonColumnTpl=new Ext.XTemplate('<tpl for="."><tpl if="action_buttons !== null"><ul class="action-buttons"><tpl for="action_buttons"><li><i class="icon {className} icon-{icon}" title="{text}"></i></li></tpl></ul></tpl></tpl>',{compiled:!0}),this.ident="cronmanager-cronjobs"+Ext.id(),Ext.applyIf(e,{id:this.ident+"-cronmanager-grid-cronjobs",url:CronManager.config.connectorUrl,baseParams:{action:"mgr/cronjobs/getlist"},save_action:"mgr/cronjobs/updatefromgrid",autosave:!0,fields:["id","snippet","snippet_name","properties","minutes","nextrun","lastrun","active","sortorder"],paging:!0,remoteSort:!0,autoExpandColumn:"snippet",emptyText:_("cronmanager.norecords"),columns:[{header:_("cronmanager.snippet"),dataIndex:"snippet_name",sortable:!0},{header:_("cronmanager.minutes"),dataIndex:"minutes",sortable:!1,width:40,editor:{xtype:"numberfield",minValue:1,description:_("cronmanager.minutes_desc"),allowNegative:!1}},{header:_("cronmanager.lastrun"),dataIndex:"lastrun",sortable:!1},{header:_("cronmanager.nextrun"),dataIndex:"nextrun",sortable:!1,editor:{xtype:"xdatetime",dateFormat:MODx.config.manager_date_format,timeFormat:MODx.config.manager_time_format}},{header:_("cronmanager.active"),dataIndex:"active",sortable:!1,width:40,renderer:MODx.grid.Grid.prototype.rendYesNo,editor:{xtype:"combo-boolean"}},{header:_("id"),dataIndex:"id",sortable:!0,hidden:!0,width:25},{renderer:{fn:this.buttonColumnRenderer,scope:this},menuDisabled:!0,width:30}],tbar:[{text:_("cronmanager.create"),cls:"primary-button",handler:this.createCronjob},{text:_("cronmanager.run_jobs"),cls:"secondary-button",handler:function(){this.runCronjobs()}},"->",{xtype:"textfield",id:this.ident+"-cronmanager-filter-search",emptyText:_("search")+"…",submitValue:!1,listeners:{change:{fn:this.search,scope:this},render:{fn:function(e){new Ext.KeyMap(e.getEl(),{key:Ext.EventObject.ENTER,fn:function(){return this.fireEvent("change",this),this.blur(),!0},scope:e})},scope:this}}},{xtype:"button",id:this.ident+"-cronmanager-filter-clear",cls:"x-form-filter-clear",text:_("filter_clear"),listeners:{click:{fn:this.clearFilter,scope:this}}}]}),CronManager.grid.CronJobs.superclass.constructor.call(this,e)},Ext.extend(CronManager.grid.CronJobs,MODx.grid.Grid,{getMenu:function(){var e=[];e.push({text:_("cronmanager.update"),handler:this.updateCronjob}),e.push("-"),e.push({text:_("cronmanager.viewlog"),handler:this.viewLog}),e.push("-"),e.push({text:_("cronmanager.run_job"),handler:this.runCronjob}),e.push("-"),e.push({text:_("cronmanager.remove"),handler:this.removeCronjob}),this.addContextMenuItem(e)},createCronjob:function(e,r){this.createUpdateCronjob(e,r,!1)},updateCronjob:function(e,r){this.createUpdateCronjob(e,r,!0)},createUpdateCronjob:function(e,r,n){var t;if(n){if(!this.menu.record||!this.menu.record.id)return!1;t=this.menu.record}else t={parameter:"{}"};n=MODx.load({xtype:"cronmanager-window-cronjob-create-update",isUpdate:n,title:n?_("cronmanager.update"):_("cronmanager.create"),record:t,listeners:{success:{fn:this.refresh,scope:this}}});n.fp.getForm().setValues(t),n.show(r.target)},removeCronjob:function(){if(!this.menu.record)return!1;MODx.msg.confirm({title:_("cronmanager.remove"),text:_("cronmanager.remove_confirm",{snippet:"<b>"+this.menu.record.snippet_name+"</b>"}),url:this.config.url,params:{action:"mgr/cronjobs/remove",id:this.menu.record.id},listeners:{success:{fn:this.refresh,scope:this}}})},runCronjob:function(){if(!this.menu.record)return!1;this.runCronjobs(this.menu.record.id)},runCronjobs:function(r=0){var e={cronjob_id:CronManager.config.cronjob_id};r&&Ext.apply(e,{job:r});var n=CronManager.config.cronUrl+"?"+Ext.urlEncode(e);Ext.apply(e,{force:!0}),MODx.msg.confirm({title:r?_("cronmanager.run_job"):_("cronmanager.run_jobs"),text:r?_("cronmanager.run_job_confirm",{id:r}):_("cronmanager.run_jobs_confirm"),url:CronManager.config.cronUrl,params:e,listeners:{success:{fn:function(e){Ext.MessageBox.alert(r?_("cronmanager.job_started"):_("cronmanager.jobs_started"),n+"<br><br>"+(r?_("cronmanager.job_started_message",{id:r}):_("cronmanager.jobs_started_message"))),this.refresh},scope:this}}})},viewLog:function(){if(!this.menu.record||!this.menu.record.id)return!1;location.href="?a=logs&namespace="+CronManager.config.namespace+"&id="+this.menu.record.id},search:function(e){this.getStore().baseParams.query=e.getValue(),this.getBottomToolbar().changePage(1),this.refresh()},clearFilter:function(){this.getStore().baseParams.query="",Ext.getCmp(this.ident+"-cronmanager-filter-search").reset(),this.getBottomToolbar().changePage(1),this.refresh()},buttonColumnRenderer:function(){var e={action_buttons:[{className:"update",icon:"pencil-square-o",text:_("cronmanager.update")},{className:"viewlog",icon:"list-ul",text:_("cronmanager.viewlog")},{className:"run_job",icon:"rocket",text:_("cronmanager.run_job")},{className:"remove",icon:"trash-o",text:_("cronmanager.remove")}]};return this.buttonColumnTpl.apply(e)},onClick:function(e){var r=e.getTarget();if("icon"===r.className.split(" ")[0]){var r=r.className.split(" ")[1],n=this.getSelectionModel().getSelected();switch(this.menu.record=n.data,r){case"remove":this.removeCronjob(n,e);break;case"update":this.updateCronjob(n,e);break;case"run_job":this.runCronjob(n,e);break;case"viewlog":this.viewLog(n,e)}}}}),Ext.reg("cronmanager-grid-cronjobs",CronManager.grid.CronJobs),CronManager.window.CreateUpdateCronjob=function(e){this.ident=(e=e||{}).ident||"cucronjob"+Ext.id(),Ext.applyIf(e,{id:this.ident,url:CronManager.config.connectorUrl,action:e.isUpdate?"mgr/cronjobs/update":"mgr/cronjobs/create",width:400,autoHeight:!0,closeAction:"close",cls:"modx-window cronmanager-window",fields:[{items:[{layout:"column",items:[{columnWidth:.6,layout:"form",items:[{xtype:"cronmanager-combo-snippets",fieldLabel:_("cronmanager.snippet"),name:"snippet",anchor:"100%",allowBlank:!1}]},{columnWidth:.2,layout:"form",items:[{xtype:"numberfield",fieldLabel:_("cronmanager.minutes"),description:_("cronmanager.minutes_desc"),name:"minutes",anchor:"100%",value:60,minValue:1,allowBlank:!1,allowNegative:!1}]},{columnWidth:.2,layout:"form",items:[{xtype:"xcheckbox",fieldLabel:_("cronmanager.active"),name:"active",hiddenName:"active",anchor:"100%"}]}]}]},{xtype:"textarea",fieldLabel:_("cronmanager.properties"),description:_("cronmanager.properties_desc"),name:"properties",anchor:"100%",allowBlank:!0,grow:!0,growMax:200},{xtype:"hidden",name:"id"}]}),CronManager.window.CreateUpdateCronjob.superclass.constructor.call(this,e)},Ext.extend(CronManager.window.CreateUpdateCronjob,MODx.Window),Ext.reg("cronmanager-window-cronjob-create-update",CronManager.window.CreateUpdateCronjob),CronManager.grid.CronJobLog=function(e){e=e||{},this.buttonColumnTpl=new Ext.XTemplate('<tpl for="."><tpl if="action_buttons !== null"><ul class="action-buttons"><tpl for="action_buttons"><li><i class="icon {className} icon-{icon}" title="{text}"></i></li></tpl></ul></tpl></tpl>',{compiled:!0}),this.sm=new Ext.grid.CheckboxSelectionModel,this.ident="cronmanager-cronjoblog"+Ext.id(),Ext.applyIf(e,{id:this.ident+"-cronmanager-grid-cronjoblog",url:CronManager.config.connectorUrl,baseParams:{action:"mgr/cronjoblogs/getlist",cronjob:e.cronjob},fields:["id","logdate","message","day","error"],paging:!0,remoteSort:!0,autoExpandColumn:"message",grouping:!0,groupBy:"day",sortBy:"logdate",sortDir:"DESC",singleText:_("cronmanager.log_message"),pluralText:_("cronmanager.log_messages"),sm:this.sm,emptyText:_("cronmanager.log.norecords"),columns:[this.sm,{header:_("cronmanager.log_error"),dataIndex:"error",width:20,renderer:function(e,r){switch(e){case"":return"-";case!1:return r.css="green",_("no");case!0:return r.css="red",_("yes")}},hidden:!0},{header:_("cronmanager.log_day"),dataIndex:"day",width:30,hidden:!0},{header:_("cronmanager.log.date"),dataIndex:"logdate",width:40,sortable:!0,renderer:Ext.util.Format.dateRenderer(MODx.config.manager_date_format+" "+MODx.config.manager_time_format)},{header:_("cronmanager.log.message"),dataIndex:"message",renderer:function(e){return"<pre>"+String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").substr(0,100)+(100<e.length?" ...":"")+"</pre>"},width:300,sortable:!0},{header:_("id"),dataIndex:"id",sortable:!0,hidden:!0,width:25},{renderer:{fn:this.buttonColumnRenderer,scope:this},menuDisabled:!0,width:30}],tbar:[{xtype:"splitbutton",text:_("cronmanager.logs_actions"),menu:new Ext.menu.Menu({cls:"x-menu-no-icon",items:[{itemId:"log-action-purge",text:_("cronmanager.logs_purge_no_err"),handler:this.purgeLogs,scope:this},{itemId:"log-action-delete-selected",text:_("cronmanager.logs_delete_selected_one"),handler:this.deleteSelectedLogs,scope:this}]}),arrowHandler:this.setBulkActionsMenuState,handler:this.setBulkActionsMenuState},"->",{xtype:"cronmanager-combo-error",submitValue:!1,listeners:{select:{fn:this.filter,scope:this}}},{xtype:"textfield",id:this.ident+"-cronmanager-filter-search",emptyText:_("search")+"…",submitValue:!1,listeners:{change:{fn:this.search,scope:this},render:{fn:function(e){new Ext.KeyMap(e.getEl(),{key:Ext.EventObject.ENTER,fn:function(){return this.fireEvent("change",this),this.blur(),!0},scope:e})},scope:this}}},{xtype:"button",id:this.ident+"-cronmanager-filter-clear",cls:"x-form-filter-clear",text:_("filter_clear"),listeners:{click:{fn:this.clearFilter,scope:this}}}]}),e.grouping&&Ext.applyIf(e,{view:new Ext.grid.GroupingView({forceFit:!0,hideGroupedColumn:!0,enableGroupingMenu:!1,enableNoGroups:!1,scrollOffset:0,groupTextTpl:'{text} ({[values.rs.length]} {[values.rs.length > 1 ? "'+(e.pluralText||_("records"))+'" : "'+(e.singleText||_("record"))+'"]})'})}),CronManager.grid.CronJobLog.superclass.constructor.call(this,e)},Ext.extend(CronManager.grid.CronJobLog,MODx.grid.Grid,{getMenu:function(e){var r,n=[],t=this.getSelectionModel().getCount();n.push({text:_("cronmanager.log_view_full"),handler:this.viewLog}),1<=t&&(r=1<t?_("cronmanager.logs_delete_selected"):_("cronmanager.logs_delete_selected_one"),n.push({text:r,handler:function(){var e=this.getSelectedAsList();if(!e)return!1;MODx.msg.confirm({title:r,text:1<t?_("cronmanager.logs_delete_selected_confirm",{n:t}):_("cronmanager.logs_delete_selected_confirm_one"),url:this.config.url,params:{action:"mgr/cronjoblogs/removeselected",ids:e},listeners:{success:{fn:function(e){this.refresh()},scope:this}}})}})),this.addContextMenuItem(n)},setBulkActionsMenuState:function(e){var r=this.getSelectionModel().getCount(),n=e.menu.getComponent("log-action-purge"),t=e.menu.getComponent("log-action-delete-selected"),o=1<r?_("cronmanager.logs_delete_selected"):_("cronmanager.logs_delete_selected_one");1<=r?t.enable():t.disable(),1<=this.getStore().getTotalCount()?n.enable():n.disable(),t.setText(o),e.showMenu()},viewLog:function(e,r){var n=MODx.load({xtype:"cronmanager-window-fulllog",record:this.menu.record,listeners:{success:{fn:this.refresh,scope:this}}});n.setValues(this.menu.record),n.show(r.target)},purgeLogs:function(){var r=Ext.getCmp(this.ident+"-cronmanager-grid-cronjoblog");if(!r)return!1;MODx.msg.confirm({title:_("cronmanager.logs_purge_title"),text:_("cronmanager.logs_purge_confirm"),url:r.url,params:{action:"mgr/cronjoblogs/purgelogs",cronjob:r.baseParams.cronjob},listeners:{success:{fn:function(e){r.refresh()},scope:this}}})},deleteSelectedLogs:function(){var e=this.getSelectionModel().getCount(),r=this.getSelectedAsList();if(!1===r)return!1;MODx.msg.confirm({title:1<e?_("cronmanager.logs_delete_selected"):_("cronmanager.logs_delete_selected_one"),text:1<e?_("cronmanager.logs_delete_selected_confirm",{n:e}):_("cronmanager.logs_delete_selected_confirm_one"),url:this.config.url,params:{action:"mgr/cronjoblogs/removeselected",ids:r},listeners:{success:{fn:function(e){this.refresh()},scope:this}}})},search:function(e){this.getStore().baseParams.query=e.getValue(),this.getBottomToolbar().changePage(1),this.refresh()},clearFilter:function(){var e=this.getStore();e.baseParams.query="",e.baseParams.error="all",Ext.getCmp(this.ident+"-cronmanager-filter-search").reset(),this.getBottomToolbar().changePage(1),this.refresh()},filter:function(e,r){this.getStore().baseParams.error=r.data.v,this.getBottomToolbar().changePage(1),this.refresh()},buttonColumnRenderer:function(){var e={action_buttons:[{className:"fulllog",icon:"eye",text:_("cronmanager.log_view_full")}]};return this.buttonColumnTpl.apply(e)},onClick:function(e){var r,n=e.getTarget();"icon"===n.className.split(" ")[0]&&(r=n.className.split(" ")[1],n=this.getSelectionModel().getSelected(),this.menu.record=n.data,"fulllog"===r&&this.viewLog(n,e))}}),Ext.reg("cronmanager-grid-cronjoblog",CronManager.grid.CronJobLog),CronManager.window.FullLog=function(e){e=e||{},Ext.applyIf(e,{title:e.record.logdate,fields:[{xtype:"textarea",name:"message",anchor:"100%",readOnly:!0,height:"150"}],buttons:[{text:_("close"),scope:this,handler:function(){this.close()}}],keys:[]}),CronManager.window.FullLog.superclass.constructor.call(this,e)},Ext.extend(CronManager.window.FullLog,MODx.Window),Ext.reg("cronmanager-window-fulllog",CronManager.window.FullLog),CronManager.page.Home=function(e){e=e||{},Ext.applyIf(e,{buttons:[{text:_("help_ex"),handler:MODx.loadHelpPane}],components:[{xtype:"cronmanager-panel-home",renderTo:"cronmanager-panel-home"}]}),CronManager.page.Home.superclass.constructor.call(this,e)},Ext.extend(CronManager.page.Home,MODx.Component),Ext.reg("cronmanager-page-home",CronManager.page.Home),CronManager.page.Logs=function(e){e=e||{},Ext.applyIf(e,{buttons:[{text:_("cronmanager.log.btnback"),id:"answers-btn-back",handler:function(){location.href="?a=home&namespace="+MODx.request.namespace},scope:this},"-",{text:_("help_ex"),handler:MODx.loadHelpPane}],components:[{xtype:"cronmanager-panel-logs",renderTo:"cronmanager-panel-logs",cronjob:MODx.request.id}]}),CronManager.page.Logs.superclass.constructor.call(this,e)},Ext.extend(CronManager.page.Logs,MODx.Component),Ext.reg("cronmanager-page-logs",CronManager.page.Logs);